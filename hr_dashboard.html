<!DOCTYPE html>
<html>
<head>
    <title>HR Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
    <script src="config.js"></script>
</head>
<body>
    <script>checkSession('HR');</script>

    <div class="container">
        <div class="navbar">
            <h2>HR Dashboard</h2>
            <button onclick="logout()" class="btn-red">Logout</button>
        </div>

        <div class="card">
            <h3>Initiate New Exit</h3>
            <input type="text" id="eid" placeholder="Emp ID (e.g. 101)">
            <input type="text" id="ename" placeholder="Name">
            <input type="text" id="edesig" placeholder="Designation">
            <button onclick="addExit()" class="btn-green">Start Process</button>
        </div>

        <h3>Exit Status Monitor</h3>
        <div id="loading">Loading data...</div>
        <table id="empTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Dept Status</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
    </div>

    <div id="pdf-template" style="display:none; padding: 20px;">
        <h1 style="text-align:center">Gretex Exit Clearance Form</h1>
        <hr>
        <p><b>Name:</b> <span id="pdfName"></span></p>
        <p><b>ID:</b> <span id="pdfId"></span></p>
        <table border="1" width="100%" cellpadding="5">
            <thead><tr><th>Department</th><th>Task</th><th>Status</th></tr></thead>
            <tbody id="pdfBody"></tbody>
        </table>
        <br><br>
        <p><b>HR Signature:</b> __________________</p>
    </div>

    <script>
        function logout() { sessionStorage.clear(); window.location.href = 'index.html'; }

        function addExit() {
            const data = {
                action: 'initiateExit',
                empId: document.getElementById('eid').value,
                name: document.getElementById('ename').value,
                designation: document.getElementById('edesig').value
            };
            fetch(API_URL, { method: 'POST', body: JSON.stringify(data) })
            .then(res => { alert('Exit Initiated!'); loadData(); });
        }

        function loadData() {
            fetch(API_URL + '?op=getEmployees')
            .then(res => res.json())
            .then(data => {
                document.getElementById('loading').style.display = 'none';
                const tbody = document.getElementById('tableBody');
                tbody.innerHTML = '';
                
                data.forEach(emp => {
                    const row = `<tr>
                        <td>${emp.empId}</td>
                        <td>${emp.name}</td>
                        <td>
                            IT: ${checkStatus(emp.checklist, 'IT')}<br>
                            Acc: ${checkStatus(emp.checklist, 'Accounts')}<br>
                            Admin: ${checkStatus(emp.checklist, 'Admin')}
                        </td>
                        <td><button onclick='generatePDF(${JSON.stringify(emp)})'>Download PDF</button></td>
                    </tr>`;
                    tbody.innerHTML += row;
                });
            });
        }

        function checkStatus(list, dept) {
            // Logic: Agar sheet me 'TRUE' hai to Done, warna Pending
            // Note: Simplification - checking if ANY task is done for MVP
            const tasks = list.filter(i => i.dept === dept && i.status === true);
            return tasks.length > 0 ? "✅" : "❌"; 
        }

        function generatePDF(emp) {
            // Fill Hidden Template
            document.getElementById('pdf-template').style.display = 'block';
            document.getElementById('pdfName').innerText = emp.name;
            document.getElementById('pdfId').innerText = emp.empId;
            
            const tbody = document.getElementById('pdfBody');
            tbody.innerHTML = '';
            
            // Default tasks list (You can expand this)
            const allTasks = [
                {d:'IT', t:'Laptop'}, {d:'IT', t:'Email'},
                {d:'Accounts', t:'FNF'}, {d:'Accounts', t:'Loans'},
                {d:'Admin', t:'ID Card'}
            ];

            allTasks.forEach(task => {
                // Check if this task is marked true in DB
                const isDone = emp.checklist.find(c => c.dept == task.d && c.task == task.t && c.status === true);
                tbody.innerHTML += `<tr><td>${task.d}</td><td>${task.t}</td><td>${isDone ? 'Cleared' : 'Pending'}</td></tr>`;
            });

            // Download
            html2pdf().from(document.getElementById('pdf-template')).save(emp.name + '_Exit.pdf').then(() => {
                document.getElementById('pdf-template').style.display = 'none';
            });
        }

        loadData();
    </script>
</body>
</html>
